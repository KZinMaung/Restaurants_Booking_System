@using Data.Constants
@model Data.ViewModels.ReserveViewModel
@{
    ViewData["Title"] = "Reserve Page";
    var res = Model.Restaurant;
    var schedules = Model.Schedules;
    var cus = Model.Customer;
    int index = 0;

}

<div>
    <h2>@res.Name</h2>
    <div class="row mt-3">
        <div class="col-12 col-md-8">
            <div class="image-container">
                <img class="cover-img" src="@res.CoverPhotoUrl" alt="Restaurant_Cover" />
            </div>

            <div class="mt-5">
                <!-- Nav -->
                <div class="mt-5 text-center">
                    <ul class="nav nav-segment nav-pills mb-7" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="nav-menu" data-bs-toggle="pill" aria-selected="true" onclick="LoadMenuList()">MENU</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="nav-about" data-bs-toggle="pill" aria-selected="false" onclick="LoadAbout()">ABOUT</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="nav-reviews" data-bs-toggle="pill" aria-selected="false" onclick="LoadReviews()">REVIEWS</a>
                        </li>
                    </ul>
                </div>
                <!-- End Nav -->
                <!-- Tab Content -->
                <div class="tab-content">
                    <div class="tab-pane fade show active" role="tabpanel" id="div_tab_content">

                    </div>
                </div>
                <!-- End Tab Content -->
            </div>

        </div>
        <div class="col-12 col-md-4">
            <h3>Reservation Information</h3>
            <form id="reservation_form" method="post">
                <div class="mb-3 pointer">
                    <label class="form-label" for="BookingDate">Date</label>
                    <input type="date" id="BookingDate" class="form-control" required onchange="ShowAvailableCount()">
                </div>

                <div class="row mb-3">
                    <label class="form-label" for="time">Time</label>
                    <div class="d-flex flex-row flex-wrap gap-3">
                        @foreach(var schedule in schedules)
                        {
                            index++;
                            <div class="">
                                <!-- Form Radio -->
                                <label class="form-control" for="time1">
                                    <span class="form-check">
                                        <input type="radio" class="form-check-input" name="time" data-id="@schedule.Id" onclick="ShowAvailableCount()" @(index == 1 ? "checked" : "")>
                                        <span class="form-check-label" id="schedule_@schedule.Id">@schedule.StartTime - @schedule.EndTime</span>
                                    </span>
                                </label>
                                <!-- End Form Radio -->
                            </div>
                        }
                        
                    </div>

                </div>
                <div class="form-label" id="div-available-count"> </div>

                <div class="mb-3">
                     <input type="number" id="txt-noOfTable" name="NoOfTable"  class="form-control" placeholder="Type table(4 person per table)" required>
                </div>
                <!-- End Row -->

                <h5>Customer Information</h5>
                <div class="my-3">

                    <input type="text" id="txt-name" name="Name" value="@cus?.Name" class="form-control" placeholder="Name" required>
                </div>
                <div class="mb-3">

                    <input type="text" id="txt-email" name="Email" value="@cus?.Email" class="form-control" placeholder="Email" required>
                </div>
                <div class="mb-3">

                    <input type="text" id="txt-phone" name="Phone" value="@cus?.Phone" class="form-control" placeholder="Phone" required>
                </div>

                <div class="d-flex flex-fill" >
                    <button type="button" class="btn btn-primary btn-sm w-100" onclick="ReviewReservation()">Review Reservation</button>
                </div>
            </form>
        </div>

        
<div class="modal fade" id="reviewReservationModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Review Reservation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4>@res.Name</h4>
                <div class="d-flex justify-content-between mb-2">
                    <span>Date: </span>
                    <span class="text-black" id="modal-date"></span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Time: </span>
                    <span class="text-black" id="modal-schedule"></span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Table count: </span>
                    <span class="text-black" id="modal-noOfTable"></span>
                </div>
                <h5 class="mt-3">Customer Information</h5>
                <div class="d-flex flex-column">
                    <span id="modal-cusName"></span>
                    <span id="modal-cusEmail"></span>
                    <span id="modal-cusPhone"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" onclick="ConfirmReservation()">Confirm</button>
            </div>
        </div>
    </div>
</div>
       
        
    </div>
</div>

@section scripts {
    <script type="text/javascript">
        var resId = @res.Id;
        var resScheId = 0;
        var selectedDate ;
        var page = 1;
        var pagesize = 5;
        var q;
        var availableCount ;
        var reservationData;

        $(function () {
            initPaging();
            LoadMenuList();
            BindTodayDate();
            ShowAvailableCount();
        });


        function BindTodayDate(){
            let today = new Date().toISOString().split('T')[0];
            $('#BookingDate').val(today);
        }


        function initPaging() {
           
            $("#div_tab_content").on("click", ".pagination-bx a", function (e) {

                e.preventDefault();
                var $a = $(this).attr("href");
                try {
                    var pageurl = $a.split(/=/);
                    page = pageurl[1];
                    if (page == null) {
                        page = 1;
                    }
                }
                catch (e) {
                    page = 1;
                }
                LoadMenuList();
            });
        }

       
        function LoadMenuList() {

            $.ajax({
                cache: false,
                url: '@Url.Action("GetList", "Menu")',
                data: {
                    resId: resId, page: page, pageSize: pagesize, q: q
                },
                beforeSend: function () {
                    $('#div_tab_content').empty().append('<div class="loading text-center"><div class= "spinner-border" role = "status"></div><div class= "text-muted" > loading...</div></div>');

                },
                success: function (data) {
                    $('#div_tab_content').empty().append(data);
                    $(".pagination li").addClass("page-item");
                    $(".pagination span").addClass("page-link");
                    $(".pagination a").addClass("page-link");


                },
                complete: function () {
                    $(".div-actions").attr("hidden", true);
                }

            });
        }

        function LoadAbout() {
            $.ajax({
                cache: false,
                url: '@Url.Action("LoadAbout", "Restaurant")',
                data: { id: resId },
                beforeSend: function () {
                    $('#div_tab_content').empty().append('<div class="loading text-center"><div class= "spinner-border" role = "status"></div><div class= "text-muted" > loading...</div></div>');

                },
                success: function (data) {
                    $('#div_tab_content').empty().append(data);

                }
            });
        }
        function LoadReviews() {
            $.ajax({
                cache: false,
                url: '@Url.Action("LoadReviews", "Customer")',
                data: {

                },
                beforeSend: function () {
                    $('#div_tab_content').empty().append('<div class="loading text-center"><div class= "spinner-border" role = "status"></div><div class= "text-muted" > loading...</div></div>');

                },
                success: function (data) {
                    $('#div_tab_content').empty().append(data);

                }
            });
        }


        function ShowAvailableCount() {
            selectedDate = $('#BookingDate').val();
            resScheId = $('input[name="time"]:checked').data('id');

            $.ajax({
                cache: false,
                url: '@Url.Action("GetAvailableCount", "Booking")',
                data: {
                    resId : resId,
                    resScheId : resScheId,
                    BookingDate : selectedDate
                },
                beforeSend: function () {
                    
                },
                success: function (count) {
                    availableCount = count;
                    var text = count + ' table(s) availabe at this time.'
                    $('#div-available-count').empty().append(text);

                }
            });
        }

        
        function ReviewReservation(){
            //get input data
            var date = $('#BookingDate').val();
            var scheduleId = $('input[name="time"]:checked').data('id');
            var scheduleText = $('#schedule_'+scheduleId).text();
            var noOfTable = $('#txt-noOfTable').val().toString();
            var cusName = $('#txt-name').val();
            var cusEmail = $('#txt-email').val();
            var cusPhone = $('#txt-phone').val();

            reservationData = {
                "CustomerId": '@cus?.Id',
                "RestaurantId": '@res.Id',
                "BookingDate": date,
                "RestaurantScheduleId": scheduleId,
                "NoOfTable": noOfTable,
                "CustomerName": cusName,
                "CustomerEmail": cusEmail,
                "CustomerPhone": cusPhone
                }


             if (!date || !scheduleId || !scheduleText || !noOfTable || !cusName || !cusEmail || !cusPhone) {
                alert("Please fill in all the required fields.");
                return; // Exit the function if validation fails
            }
            else if(noOfTable > availableCount){
                alert("You can't book tables more than available count!");
                return;
            }

            //bind data to modal
            $('#modal-date').text(date);
            $('#modal-schedule').text(scheduleText);
            $('#modal-noOfTable').text(noOfTable);
            $('#modal-cusName').text(cusName);
            $('#modal-cusEmail').text(cusEmail);
            $('#modal-cusPhone').text(cusPhone);

             $('#reviewReservationModal').modal('show');
        }

        function ConfirmReservation() {
            $.ajax({
                cache: false,
                url: '@Url.Action("UpSert", "Booking")',
                type:'Post',
                data: { data : reservationData },
                beforeSend: function () {
                    $('.btn').prop("disabled", true);
                },
                success: function (data) {
                    console.log("data:", data);
                    if (data?.Status == "@ResponseStatus.Success") {
                        $('#reviewReservationModal').modal('hide');
                        alert("Success!!");
                        
                    }
                    else {
                        alert("Try again!!")
                    }
                },
                complete: function () {
                    $('.btn').prop("disabled", false);


                }
            });
        }


    </script>
}