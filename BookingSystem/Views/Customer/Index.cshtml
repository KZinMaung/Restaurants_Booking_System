@using Data.Constants
@{
    ViewData["Title"] = "Home Page";
}

<div class="text-center mt-5">

    <div class="d-flex flex-column justify-content-center align-items-center background-img w-100 vh-30">
        <div class="w-50 gap-3">
            <img src="~/img/tabletalk-letter.png" style="width: 218px; height: 35px;" />
            <h3 class="text-white my-3">Restaurant Reservation</h3>
            <form action="">
                <div class="input-card input-card-sm">
                    <div class="input-card-form">
                        <input type="text" class="form-control form-control-md" placeholder="Restaurant name..." aria-label="Restaurant name" id="txt_name">
                    </div>
                    <button type="button" class="btn btn-primary btn-sm">Search</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="row contant-space-1 mt-5" id="title" hidden>
    <h2 class="m-0" style="line-height: 1.5;">Popular Restaurants</h2>
</div>
<div id="div_restaurants">
    <!-- Popular Restaurants -->

    <div class="row contant-space-1 mt-5">
        <div class="d-flex justify-content-between">
            <h2 class="m-0" style="line-height: 1.5;">Most Popular Restaurants</h2>
            <button type="button" class="btn btn-ghost btn-sm" onclick="ViewAllPopularRestaurants()">
                View all
                <i class="bi-arrow-right-short ms-1"></i>
            </button>
        </div>
        <div id="div_popular_restaurants">

        </div>
    
    </div>

    <!-- End Popular Restaurants -->
    <!-- New Restaurants -->
    <div class="row contant-space-1">
        <div class="d-flex justify-content-between">
            <h2 class="m-0" style="line-height: 1.5;">Newest Restaurants</h2>
            <button type="button" class="btn btn-ghost btn-sm" onclick="ViewAllNewRestaurants()">
                View all
                <i class="bi-arrow-right-short ms-1"></i>
            </button>
        </div>
        <div id="div_new_restaurants">

        </div>

    </div>
    <!-- End New Restaurants -->
</div>



<!-- Profile Offcanvas -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="customerFormOffcanvas" aria-labelledby="offcanvasRightLabel">
    <div class="offcanvas-header">
        <h3 id="offcanvasRightLabel mb-0">Profile</h3>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column justify-content-between">
        <div id="div-customer-form">
        </div>

        <div class="d-flex border">
            <button type="button" class="btn btn-outline-danger btn-sm w-100">Logout</button>
        </div>
    </div>
</div>
<!-- Profile Offcanvas -->

@section scripts{
   <script type="text/javascript">

        var page = 1;
        var pagesize = 9;
        var q;

        $(function () {
            LoadMostPopularRestaurants();
            LoadNewestRestaurants();

            initPaging();
        });




        let input = document.getElementById('txt_name');
        let timeout = null;

        input.addEventListener('keyup', function (e) {
            clearTimeout(timeout);

            timeout = setTimeout(function () {
                Search();
            }, 1000);
        });


        function Search() {

            q = $('#txt_name').val().trim();
            page = 1;
            LoadMainList();

        }

        function initPaging() {
            $("#div_restaurants").on("click", ".pagination-bx a", function (e) {
                e.preventDefault();
                var $a = $(this).attr("href");
                try {
                    var pageurl = $a.split(/=/);
                    page = pageurl[1];
                    if (page == null) {
                        page = 1;
                    }
                }
                catch (e) {
                    page = 1;
                }
                LoadMainList();
            });
        }

        function LoadMainList() {

            $.ajax({
                cache: false,
                url: '@Url.Action("GetAllPopularRestaurants", "Restaurant")',
                data: {
                    page: page, pageSize: pagesize, q: q
                },
                beforeSend: function () {
                    $('#div_restaurants').empty().append('<div class="loading text-center"><div class= "spinner-border" role = "status"></div><div class= "text-muted" > loading...</div></div>');

                },
                success: function (data) {
                    $("#title").removeAttr("hidden");
                    $('#div_restaurants').empty().append(data);
                    $(".pagination li").addClass("page-item");
                    $(".pagination span").addClass("page-link");
                    $(".pagination a").addClass("page-link");


                },
                complete: function () {

                }

            });
        }
        function LoadMostPopularRestaurants() {
            $.ajax({
                cache: false,
                url: '@Url.Action("GetMostPopularRestaurants", "Restaurant")',
                data: {

                },
                beforeSend: function () {
                    $('#div_popular_restaurants').empty().append('<div class="loading text-center"><div class= "spinner-border" role = "status"></div><div class= "text-muted" > loading...</div></div>');

                },
                success: function (data) {
                    $('#div_popular_restaurants').empty().append(data);

                }
            });
        }


        function LoadNewestRestaurants() {
            $.ajax({
                cache: false,
                    url: '@Url.Action("GetNewestRestaurants", "Restaurant")',
                data: {

                },
                beforeSend: function () {
                    $('#div_new_restaurants').empty().append('<div class="loading text-center"><div class= "spinner-border" role = "status"></div><div class= "text-muted" > loading...</div></div>');

                },
                success: function (data) {
                    $('#div_new_restaurants').empty().append(data);

                }
            });
        }


       

        function ViewAllPopularRestaurants(){
            location.href = '../Restaurant/ViewAllPopularRestaurants';
        }

        function ViewAllNewRestaurants(){
            location.href = '../Restaurant/ViewAllNewRestaurants';
        }


        function Reserve(id){
            location.href = '../Customer/Reserve/' + id;
        }


        function EditCustomerProfile(e) {
            var id = $(e).attr('data-id');
            Form("Edit", id)
        }

        function Form(FormType, Id) {
            $.ajax({
                cache: false,
                url: '@Url.Action("CustomerForm", "Customer")',
                data: { FormType: FormType, Id: Id },
                beforeSend: function () {

                },
                success: function (data) {
                    $('#div-customer-form').empty().append(data);
                    $('#customerFormOffcanvas').offcanvas('show');

                },
                complete: function () {


                    $('#customerForm').submit(function (e) {

                        e.preventDefault();

                        $.ajax({
                            cache: false,
                            url: '@Url.Action("UpSert", "Customer")',
                            type: "Post",
                            data: $(this).serialize(),
                            beforeSend: function () {
                                $('.btn').prop("disabled", true);
                            },
                            success: function (data) {
                                console.log("data:", data);
                                if (data?.Status == "@ResponseStatus.Success") {
                                    $('#customerFormOffcanvas').offcanvas('hide');
                                    alert("Success!!");

                                }
                                else {
                                    alert("Failed!!")
                                }

                            },
                            complete: function () {
                                $('.btn').prop("disabled", false);


                            }
                        });
                    });
                }

            });
        }



   </script>
}